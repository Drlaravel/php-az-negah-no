<div dir="rtl" style="font-family: 'Vazir', sans-serif; line-height: 1.8;">
---
در فصل یازدهم، به مبحث امنیت در PHP می‌پردازیم. امنیت یکی از مهم‌ترین جنبه‌های توسعه وب است که می‌تواند تأثیر بزرگی بر روی حفاظت از داده‌های کاربران و جلوگیری از حملات مخرب داشته باشد. در این فصل، به بررسی تهدیدهای امنیتی رایج، روش‌های محافظت در برابر آن‌ها، و بهترین شیوه‌ها برای برنامه‌نویسی ایمن در PHP پرداخته خواهد شد.

### **فصل یازدهم: امنیت در PHP**

---

### **11.1 مقدمه‌ای بر امنیت در PHP**

امنیت در برنامه‌های وب یک موضوع پیچیده و چندجانبه است که شامل حفاظت از داده‌های حساس کاربران، جلوگیری از دسترسی‌های غیرمجاز، و مقابله با حملات مختلفی مانند XSS، SQL Injection، CSRF، و غیره می‌شود. PHP به عنوان یکی از پرکاربردترین زبان‌های برنامه‌نویسی برای توسعه وب، ابزارها و روش‌های مختلفی برای افزایش امنیت برنامه‌ها ارائه می‌دهد.

### **11.2 حملات XSS (Cross-Site Scripting) و جلوگیری از آن**

حملات XSS یکی از رایج‌ترین تهدیدات امنیتی برای برنامه‌های وب است. در حملات XSS، مهاجم می‌تواند اسکریپت‌های مخرب را در صفحات وب تزریق کند تا اطلاعات کاربر را به سرقت ببرد یا تغییرات غیرمجاز انجام دهد.

#### **11.2.1 انواع حملات XSS**

1. **XSS ذخیره‌شده (Stored XSS):** در این نوع حمله، کد مخرب به طور دائمی در سرور ذخیره می‌شود (مثلاً در یک پایگاه داده). این نوع حمله می‌تواند بسیار خطرناک باشد زیرا هر بار که کاربر به صفحه مربوطه مراجعه می‌کند، کد مخرب اجرا می‌شود.

2. **XSS بازتابی (Reflected XSS):** در این نوع حمله، کد مخرب به صورت موقت در سرور قرار می‌گیرد و در پاسخ به درخواست کاربر بازتاب می‌شود. این نوع حمله معمولاً با ارسال لینک‌های مخرب به کاربر همراه است.

3. **XSS مبتنی بر DOM (DOM-Based XSS):** در این نوع حمله، کد مخرب در سمت کلاینت (مرورگر) و بدون ارتباط با سرور اجرا می‌شود.

#### **11.2.2 جلوگیری از حملات XSS**

برای جلوگیری از حملات XSS، باید از تزریق کدهای مخرب در صفحات وب جلوگیری شود. برای این کار، باید تمام ورودی‌های کاربر را پاکسازی کرد.

**مثال: استفاده از `htmlspecialchars()` برای جلوگیری از XSS:**

```php
<?php
$user_input = "<script>alert('XSS Attack!');</script>";
$safe_input = htmlspecialchars($user_input, ENT_QUOTES, 'UTF-8');
echo $safe_input; // خروجی ایمن: &lt;script&gt;alert('XSS Attack!');&lt;/script&gt;
?>
```

### **11.3 حملات SQL Injection و جلوگیری از آن**

SQL Injection نوعی حمله است که در آن مهاجم می‌تواند از طریق ورودی‌های کاربر، دستورات SQL مخرب را به پایگاه داده ارسال کند. این حملات می‌توانند به سرقت داده‌ها، تغییر داده‌ها، یا حتی حذف کل پایگاه داده منجر شوند.

#### **11.3.1 روش‌های جلوگیری از SQL Injection**

1. **استفاده از دستورات آماده (Prepared Statements):** این روش به شما امکان می‌دهد که داده‌های ورودی را از دستورات SQL جدا کنید، که از اجرای دستورات مخرب جلوگیری می‌کند.

**مثال: استفاده از دستورات آماده با MySQLi:**

```php
<?php
$conn = new mysqli($servername, $username, $password, $dbname);
$stmt = $conn->prepare("SELECT * FROM users WHERE username = ?");
$stmt->bind_param("s", $username);
$username = $_POST['username']; // دریافت نام کاربری از فرم
$stmt->execute();
$result = $stmt->get_result();
?>
```

2. **استفاده از PDO با دستورات آماده:** PDO نیز از دستورات آماده پشتیبانی می‌کند که به شما امکان می‌دهد از تزریق SQL جلوگیری کنید.

**مثال: استفاده از دستورات آماده با PDO:**

```php
<?php
$dsn = "mysql:host=localhost;dbname=testdb";
$conn = new PDO($dsn, $username, $password);
$stmt = $conn->prepare("SELECT * FROM users WHERE username = :username");
$stmt->bindParam(':username', $username);
$username = $_POST['username']; // دریافت نام کاربری از فرم
$stmt->execute();
$result = $stmt->fetchAll();
?>
```

### **11.4 حملات CSRF (Cross-Site Request Forgery) و جلوگیری از آن**

حملات CSRF به مهاجمان این امکان را می‌دهند که اقدامات ناخواسته‌ای را به نام کاربران معتبر انجام دهند. این حملات معمولاً با ارسال درخواست‌های مخرب به یک وب‌سایت از طریق یک کاربر احراز هویت‌شده انجام می‌شوند.

#### **11.4.1 جلوگیری از حملات CSRF با استفاده از توکن‌های CSRF**

برای جلوگیری از حملات CSRF، باید از توکن‌های CSRF استفاده کرد. این توکن‌ها به هر فرم اضافه می‌شوند و تنها زمانی که درخواست معتبر باشد، پردازش می‌شوند.

**مثال: ایجاد و اعتبارسنجی توکن CSRF:**

```php
<?php
session_start();
if (empty($_SESSION['csrf_token'])) {
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32)); // ایجاد توکن CSRF
}

// استفاده از توکن در فرم
echo '<input type="hidden" name="csrf_token" value="' . $_SESSION['csrf_token'] . '">';

// اعتبارسنجی توکن CSRF پس از ارسال فرم
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (!hash_equals($_SESSION['csrf_token'], $_POST['csrf_token'])) {
        die('Invalid CSRF token');
    }
    // پردازش فرم
}
?>
```

### **11.5 مدیریت و حفاظت از نشست‌ها (Sessions) در PHP**

نشست‌ها برای مدیریت وضعیت کاربر بین صفحات وب استفاده می‌شوند. نشست‌ها می‌توانند هدف حملات مختلفی مانند سرقت نشست (Session Hijacking) و حملات Fixation باشند.

#### **11.5.1 اقدامات امنیتی برای مدیریت نشست‌ها**

1. **استفاده از `session_regenerate_id()` برای جلوگیری از Session Fixation:**

```php
<?php
session_start();
session_regenerate_id(true); // ایجاد یک شناسه نشست جدید برای جلوگیری از حملات Fixation
?>
```

2. **تنظیم دسترسی‌های مناسب برای کوکی‌های نشست:**

```php
<?php
session_set_cookie_params([
    'lifetime' => 86400,
    'path' => '/',
    'domain' => 'example.com',
    'secure' => true, // فقط ارسال از طریق HTTPS
    'httponly' => true, // دسترسی فقط از طریق HTTP، عدم دسترسی از جاوااسکریپت
    'samesite' => 'Strict', // جلوگیری از ارسال کوکی از سایت‌های دیگر
]);
session_start();
?>
```

### **11.6 استفاده از فیلترها و توابع اعتبارسنجی داده‌ها**

PHP مجموعه‌ای از توابع و فیلترها برای اعتبارسنجی و پاکسازی داده‌های ورودی ارائه می‌دهد. استفاده از این فیلترها به شما کمک می‌کند تا از ورودی‌های غیرمجاز و مخرب جلوگیری کنید.

#### **11.6.1 استفاده از `filter_var()` برای اعتبارسنجی داده‌ها**

**مثال: اعتبارسنجی آدرس ایمیل:**

```php
<?php
$email = $_POST['email'];
if (filter_var($email, FILTER_VALIDATE_EMAIL)) {
    echo "Valid email address.";
} else {
    echo "Invalid email address.";
}
?>
```

#### **11.6.2 استفاده از `filter_input()` برای اعتبارسنجی داده‌های ورودی**

**مثال: دریافت و اعتبارسنجی داده‌های ورودی از فرم:**

```php
<?php
$username = filter_input(INPUT_POST, 'username', FILTER_SANITIZE_STRING);
if ($username) {
    echo "Username is valid: " . htmlspecialchars($username);
} else {
    echo "Invalid username.";
}
?>
```

### **11.7 استفاده از HTTPS برای امنیت بیشتر**

استفاده از HTTPS به جای HTTP به شما این امکان را می‌دهد که داده‌های ارسال‌شده بین کاربر و سرور رمزگذاری شوند. این کار از شنود و تغییر داده‌ها توسط مهاجمان جلوگیری می‌کند.

### **11.8 مدیریت خطاها و گزارش‌دهی در PHP**

در محیط تولید، نباید خطاها و گزارش‌ها به کاربر نهایی نمایش داده شوند. به جای آن، باید از فایل‌های لاگ برای ذخیره خطاها استفاده شود.

**مثال: تنظیمات گزارش‌دهی خطاها در PHP:**

```php
<?php
ini_set('display_errors', 0); // عدم نمایش خطاها در مرورگر
ini_set('log_errors', 1); // فعال‌سازی گزارش خطاها
ini_set('error_log', '/path/to/php-error.log'); // مسیر فایل لاگ خطاها
?>
```

### **11.9 جلوگیری از حملات بر اساس فایل‌های آپلودی**

فایل‌های آپلودی یکی از رایج‌ترین منابع حملات برای مها

جمان هستند. برای محافظت از فایل‌های آپلودی باید اقدامات زیر را انجام داد:

1. **محدود کردن انواع فایل‌های مجاز برای آپلود:**

```php
<?php
$allowed_types = ['image/jpeg', 'image/png', 'image/gif'];
if (!in_array($_FILES['file']['type'], $allowed_types)) {
    die('Invalid file type.');
}
?>
```

2. **بررسی اندازه فایل‌های آپلودی و محدود کردن آن‌ها:**

```php
<?php
if ($_FILES['file']['size'] > 2 * 1024 * 1024) { // حداکثر 2 مگابایت
    die('File is too large.');
}
?>
```

3. **استفاده از نام فایل‌های تصادفی برای جلوگیری از دسترسی غیرمجاز:**

```php
<?php
$target_dir = "uploads/";
$target_file = $target_dir . bin2hex(random_bytes(16)) . "." . pathinfo($_FILES['file']['name'], PATHINFO_EXTENSION);
move_uploaded_file($_FILES['file']['tmp_name'], $target_file);
?>
```

### **11.10 تمرین‌های فصل یازدهم**

1. **محافظت در برابر XSS:** برنامه‌ای بنویسید که ورودی‌های کاربر را پاکسازی کرده و از حملات XSS جلوگیری کند.
   
2. **جلوگیری از SQL Injection:** برنامه‌ای ایجاد کنید که از دستورات آماده برای جلوگیری از SQL Injection استفاده کند.
   
3. **استفاده از توکن‌های CSRF:** برنامه‌ای بنویسید که فرم‌ها را با توکن‌های CSRF محافظت کند و درخواست‌های مخرب را شناسایی کند.
   
4. **مدیریت نشست‌ها و امنیت کوکی‌ها:** برنامه‌ای ایجاد کنید که از کوکی‌های ایمن و نشست‌ها برای مدیریت وضعیت کاربر استفاده کند.
   
5. **اعتبارسنجی و پاکسازی داده‌ها:** برنامه‌ای بنویسید که داده‌های ورودی کاربر را قبل از پردازش و ذخیره‌سازی اعتبارسنجی و پاکسازی کند.

### **خلاصه فصل یازدهم**

در این فصل، به بررسی تهدیدهای امنیتی رایج در برنامه‌های وب و روش‌های مقابله با آن‌ها در PHP پرداختیم. یاد گرفتید که چگونه با استفاده از ابزارها و روش‌های مختلف از حملات XSS، SQL Injection، CSRF و دیگر تهدیدها جلوگیری کنید. امنیت یکی از مهم‌ترین جنبه‌های توسعه وب است و پیروی از بهترین شیوه‌ها می‌تواند به شما کمک کند تا برنامه‌های امن و قابل اعتمادتری بسازید.

---

</div>